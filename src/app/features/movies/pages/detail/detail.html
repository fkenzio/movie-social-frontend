<app-navbar></app-navbar>

<!-- Loading -->
<div *ngIf="isLoading" class="loading-container">
  <div class="spinner"></div>
  <p>Cargando pel√≠cula...</p>
</div>

<!-- Movie Detail -->
<div *ngIf="!isLoading && movie" class="movie-detail">
  
  <!-- Backdrop Hero -->
  <div class="movie-hero" [style.background-image]="'url(' + getBackdropUrl(movie.backdrop_path) + ')'">
    <div class="hero-overlay"></div>
    <div class="hero-content">
      <div class="movie-poster-large">
        <img [src]="getImageUrl(movie.poster_path)" [alt]="movie.title" />
      </div>
      
      <div class="movie-header">
        <h1>{{ movie.title }}</h1>
        <p class="tagline" *ngIf="movie.tagline">{{ movie.tagline }}</p>
        
        <div class="movie-meta">
          <span class="year">{{ movie.release_date.substring(0, 4) }}</span>
          <span class="separator">‚Ä¢</span>
          <span class="runtime">{{ getRuntime(movie.runtime) }}</span>
          <span class="separator">‚Ä¢</span>
          <span class="rating" [style.color]="getRatingColor(movie.vote_average)">
            ‚≠ê {{ movie.vote_average.toFixed(1) }}
          </span>
        </div>

        <div class="genres">
          <span *ngFor="let genre of movie.genres" class="genre-tag">
            {{ genre.name }}
          </span>
        </div>

        <div class="action-buttons">
        <button class="btn btn-primary" (click)="openRatingModal()">
            ‚≠ê {{ userRating > 0 ? 'Editar Calificaci√≥n' : 'Calificar' }}
        </button>
          <button class="btn btn-secondary">
            üìù Rese√±ar
          </button>
          <button class="btn btn-secondary" (click)="openAddToListModal()">
            ‚ûï Agregar a Lista
          </button>
          <!-- Add to List Modal -->
          <app-add-to-list-modal
            *ngIf="showAddToListModal && movie"
            [movieId]="movie.id"
            [movieTitle]="movie.title"
            (close)="closeAddToListModal()"
          ></app-add-to-list-modal>
          <button *ngIf="trailerUrl" class="btn btn-secondary" (click)="toggleTrailer()">
            üé¨ Ver Trailer
          </button>
        </div>
        <!-- Rating Stats Section -->
        <div class="rating-stats" *ngIf="movieStats">
          <div class="stat-card">
            <h3>TMDB</h3>
            <div class="stat-rating">
              <app-rating-stars 
                [rating]="getTmdbRating()" 
                [readonly]="true"
                size="medium">
              </app-rating-stars>
              <span class="rating-count">({{ movie.vote_count || 0 }} votos)</span>
            </div>
          </div>
          
          <div class="stat-card highlight">
            <h3>Cineminha</h3>
            <div class="stat-rating">
              <app-rating-stars 
                [rating]="movieStats.users_average" 
                [readonly]="true"
                size="medium">
              </app-rating-stars>
              <span class="rating-count">({{ movieStats.total_ratings }} usuarios)</span>
            </div>
          </div>
          
          <div class="stat-card user-rating" *ngIf="userRating > 0">
            <h3>Tu Calificaci√≥n</h3>
            <div class="stat-rating">
              <app-rating-stars 
                [rating]="userRating" 
                [readonly]="true"
                size="medium">
              </app-rating-stars>
              <button class="btn-icon" (click)="deleteRating()" title="Eliminar">üóëÔ∏è</button>
            </div>
          </div>
        </div>

        <!-- Rating Modal -->
        <div *ngIf="showRatingModal" class="rating-modal" (click)="closeRatingModal()">
          <div class="rating-modal-content" (click)="$event.stopPropagation()">
            <button class="close-btn" (click)="closeRatingModal()">‚úï</button>
            
            <h2>Califica esta pel√≠cula</h2>
            <p class="movie-title">{{ movie.title }}</p>
            
            <div class="rating-selector">
              <app-rating-stars 
                [rating]="tempRating" 
                (ratingChange)="onRatingChange($event)"
                [readonly]="false"
                size="large">
              </app-rating-stars>
            </div>
            
            <div class="modal-actions">
              <button class="btn btn-secondary" (click)="closeRatingModal()">
                Cancelar
              </button>
              <button 
                class="btn btn-primary" 
                (click)="saveRating()"
                [disabled]="isSavingRating || tempRating === 0"
              >
                {{ isSavingRating ? 'Guardando...' : 'Guardar Calificaci√≥n' }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Trailer Modal -->
  <div *ngIf="showTrailer" class="trailer-modal" (click)="toggleTrailer()">
    <div class="trailer-content" (click)="$event.stopPropagation()">
      <button class="close-btn" (click)="toggleTrailer()">‚úï</button>
      <iframe
        *ngIf="trailerUrl"
        [src]="trailerUrl"
        frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        allowfullscreen>
      </iframe>
    </div>
  </div>

  <!-- Movie Info -->
  <div class="movie-content">
    
    <!-- Overview -->
    <section class="section">
      <h2>Sinopsis</h2>
      <p class="overview">{{ movie.overview || 'No hay sinopsis disponible.' }}</p>
    </section>

    <!-- Cast -->
    <section class="section" *ngIf="getCast().length > 0">
      <h2>Reparto Principal</h2>
      <div class="cast-grid">
        <div *ngFor="let actor of getCast()" class="cast-card">
          <div class="cast-photo">
            <img 
              [src]="actor.profile_path ? getImageUrl(actor.profile_path) : 'assets/no-avatar.png'" 
              [alt]="actor.name"
            />
          </div>
          <div class="cast-info">
            <p class="actor-name">{{ actor.name }}</p>
            <p class="character-name">{{ actor.character }}</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Similar Movies -->
    <section class="section" *ngIf="getSimilarMovies().length > 0">
      <h2>Pel√≠culas Similares</h2>
      <div class="similar-grid">
        <div 
          *ngFor="let similar of getSimilarMovies()" 
          class="similar-card"
          [routerLink]="['/movies/detail', similar.id]"
        >
          <img [src]="getImageUrl(similar.poster_path)" [alt]="similar.title" />
          <div class="similar-info">
            <h4>{{ similar.title }}</h4>
            <span class="similar-rating">‚≠ê {{ similar.vote_average.toFixed(1) }}</span>
          </div>
        </div>
      </div>
    </section>

  </div>
</div>